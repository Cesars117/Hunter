name: ðŸ”§ Hunter CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # â”€â”€â”€ BUILD & TEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ðŸ—ï¸ Build & Verify
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          DATABASE_URL: "file:./dev.db"
          JWT_SECRET: "ci-test-secret-key"

      - name: âœ… Build successful
        run: echo "Build completed successfully!"

  # â”€â”€â”€ DEPLOY TO HOSTINGER (SSH) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ðŸš€ Deploy to Hostinger
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ—ï¸ Build standalone
        run: npm run build
        env:
          DATABASE_URL: "file:./prisma/prod.db"
          JWT_SECRET: "build-placeholder"

      - name: ðŸ“‹ Prepare deployment package
        run: |
          # Copy static files to standalone
          cp -r .next/static .next/standalone/.next/static
          mkdir -p .next/standalone/public
          [ -d "public" ] && cp -r public/* .next/standalone/public/ || true
          
          # Copy prisma schema
          mkdir -p .next/standalone/prisma
          cp prisma/schema.prisma .next/standalone/prisma/
          
          # Copy server and config files
          cp server.js .next/standalone/
          cp package.json .next/standalone/
          cp .env.production .next/standalone/.env

      - name: ðŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT || 65002 }}
          script: |
            cd ${{ secrets.HOSTINGER_APP_PATH || '~/domains/hunter.cdsrsolutions.com/public_html' }}
            
            echo "ðŸ”„ Stopping app..."
            # Backup database
            [ -f "prisma/prod.db" ] && cp prisma/prod.db /tmp/hunter-prod-backup.db
            
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            echo "ðŸ“¦ Installing dependencies..."
            npm ci --production
            
            echo "ðŸ”§ Generating Prisma..."
            npx prisma generate
            
            echo "ðŸ—ï¸ Building..."
            npm run build
            
            # Prepare standalone
            cp -r .next/static .next/standalone/.next/static
            mkdir -p .next/standalone/public
            [ -d "public" ] && cp -r public/* .next/standalone/public/ || true
            mkdir -p .next/standalone/prisma
            cp prisma/schema.prisma .next/standalone/prisma/
            cp server.js .next/standalone/
            
            # Restore database backup
            [ -f "/tmp/hunter-prod-backup.db" ] && cp /tmp/hunter-prod-backup.db prisma/prod.db
            [ -f "prisma/prod.db" ] && cp prisma/prod.db .next/standalone/prisma/
            
            # Migrate database
            npx prisma db push --accept-data-loss
            
            echo "ðŸ”„ Restarting app..."
            # Hostinger restart (varies by setup)
            touch tmp/restart.txt 2>/dev/null || true
            
            echo "âœ… Deploy completed!"

      - name: âœ… Deploy successful
        run: echo "ðŸŽ‰ Deployed to hunter.cdsrsolutions.com"
