// Prisma Schema - Hunter - Sistema Multi-Empresa de Taller Mecánico
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─── EMPRESA (TENANT) ──────────────────────────────────
model Company {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique // identificador único para la empresa
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  customers    Customer[]
  vehicles     Vehicle[]
  estimates    Estimate[]
  workOrders   WorkOrder[]
  shopSettings ShopSettings?

  @@map("companies")
}

// ─── USUARIOS ──────────────────────────────────────────
model User {
  id        String   @id @default(cuid())
  companyId String
  email     String   @unique
  password  String   // hashed
  name      String
  role      String   @default("ADMIN") // ADMIN, MANAGER, TECH
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("users")
}

// ─── CLIENTES ──────────────────────────────────────────
model Customer {
  id        String   @id @default(cuid())
  companyId String
  firstName String
  lastName  String
  email     String?
  phone     String
  phone2    String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vehicles  Vehicle[]
  estimates Estimate[]

  @@map("customers")
}

// ─── VEHÍCULOS ─────────────────────────────────────────
model Vehicle {
  id           String   @id @default(cuid())
  companyId    String
  customerId   String
  year         Int
  make         String
  model        String
  trim         String?
  color        String?
  vin          String?  @unique
  licensePlate String?
  mileage      Int?
  engineType   String?
  transmission String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  customer  Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  estimates Estimate[]

  @@map("vehicles")
}

// ─── ESTIMADOS ─────────────────────────────────────────
model Estimate {
  id             String         @id @default(cuid())
  companyId      String
  estimateNumber String         @unique
  customerId     String
  vehicleId      String
  status         String         @default("DRAFT") // DRAFT, SENT, APPROVED, REJECTED, IN_PROGRESS, COMPLETED, CANCELLED
  
  // Descripción general
  description    String?
  diagnosticNotes String?
  
  // Totales
  subtotal       Float          @default(0)
  taxRate        Float          @default(11.5) // IVU PR o tax rate aplicable
  taxAmount      Float          @default(0)
  discount       Float          @default(0)
  total          Float          @default(0)
  
  // Fechas
  estimateDate   DateTime       @default(now())
  approvedDate   DateTime?
  completedDate  DateTime?
  expiresAt      DateTime?
  
  // Notas
  internalNotes  String?
  customerNotes  String?
  
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  customer       Customer       @relation(fields: [customerId], references: [id])
  vehicle        Vehicle        @relation(fields: [vehicleId], references: [id])
  company        Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  items          EstimateItem[]
  workOrder      WorkOrder?

  @@map("estimates")
}

// ─── LÍNEAS DE ESTIMADO ────────────────────────────────
model EstimateItem {
  id          String   @id @default(cuid())
  estimateId  String
  type        String   // PART, LABOR, SUBLET, FEE, DISCOUNT
  description String
  
  // Para partes
  partNumber  String?
  brand       String?
  supplier    String?  // Para futuras APIs de proveedores
  
  // Cantidades y precios
  quantity    Float    @default(1)
  unitPrice   Float    @default(0)
  cost        Float    @default(0) // Costo real (para calcular margen)
  amount      Float    @default(0) // quantity * unitPrice
  taxable     Boolean  @default(true)
  
  // Horas (para labor)
  hours       Float?
  laborRate   Float?
  
  sortOrder   Int      @default(0)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  estimate    Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  @@map("estimate_items")
}

// ─── ÓRDENES DE TRABAJO ────────────────────────────────
model WorkOrder {
  id              String   @id @default(cuid())
  companyId       String
  workOrderNumber String   @unique
  estimateId      String   @unique
  status          String   @default("PENDING") // PENDING, IN_PROGRESS, WAITING_PARTS, ON_HOLD, COMPLETED, DELIVERED
  
  assignedTo      String?  // Mecánico asignado
  bay             String?  // Bahía/estación de trabajo
  priority        String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  
  startDate       DateTime?
  estimatedCompletion DateTime?
  completedDate   DateTime?
  deliveredDate   DateTime?
  
  techNotes       String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  estimate        Estimate @relation(fields: [estimateId], references: [id])
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tasks           WorkTask[]

  @@map("work_orders")
}

// ─── TAREAS DE TRABAJO ─────────────────────────────────
model WorkTask {
  id          String   @id @default(cuid())
  workOrderId String
  description String
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, SKIPPED
  assignedTo  String?
  timeSpent   Float?   // Horas reales
  notes       String?
  completedAt DateTime?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@map("work_tasks")
}

// ─── CONFIGURACIÓN DEL TALLER ──────────────────────────
model ShopSettings {
  id            String @id @default(cuid())
  companyId     String @unique
  shopName      String @default("Mi Taller")
  address       String?
  city          String?
  state         String?
  zipCode       String?
  phone         String?
  email         String?
  website       String?
  taxRate       Float  @default(11.5)
  laborRate     Float  @default(85.0)
  logo          String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("shop_settings")
}
